{% extends "users/base.html" %}

{% block content %}
    <div class="container">
        <h2>Hello, {{ username }}!</h2>
        <p>Welcome to your personalized landing page.</p>
        
        <div>
            <input id="location-input" type="text" placeholder="Enter a location">
            <input id="restaurant-input" type="text" placeholder="Enter a restaurant name or cuisine type">
            <input id="rating-filter" type="text" placeholder="Enter a minimum rating">
            <input id="distance-filter" type="text" placeholder="Enter a maximum distance in miles">

            <button onclick="searchRestaurants()">Search Restaurants</button>
        </div>

        <div id="map" style="height: 500px; width: 100%;"></div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPk9gIYRT86DoMATTsLjHBOUVR7jDVs70&libraries=places"></script>

    <script>
        var map;
        var service;
        var infowindow;
        var geocoder;
        var markers = [];

        function initMap() {
            var atlanta = { lat: 33.753746, lng: -84.386330 };
            map = new google.maps.Map(document.getElementById("map"), {
                center: atlanta,
                zoom: 10
            });

            infowindow = new google.maps.InfoWindow();
            geocoder = new google.maps.Geocoder();
        }

        function searchRestaurants() {
            var locationInput = document.getElementById("location-input").value;
            if (locationInput === '') {
                locationInput = 'atlanta';
            }
            var restaurantInput = document.getElementById("restaurant-input").value;
            if (restaurantInput === '') {
                restaurantInput = 'restaurant';
            }
            var maxDistance = parseFloat(document.getElementById("distance-filter").value) * 1609.344;
            if (isNaN(maxDistance)) {
                maxDistance = 5000;
            }
            var minRating = parseFloat(document.getElementById("rating-filter").value);
            if (isNaN(minRating)) {
                minRating = 0.0;
            }
            if (minRating > 5) {
                minRating = 5;
            }

            geocoder.geocode({ 'address': locationInput }, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    var location = results[0].geometry.location;
                    map.setCenter(location);

                    var request = {
                        location: location,
                        radius: maxDistance,
                        query: restaurantInput,
                        fields: ['place_id', 'name', 'geometry']
                    };

                    service = new google.maps.places.PlacesService(map);
                    service.textSearch(request, function(results, status) {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            clearMarkers();

                            var filteredResults = [];
                            for (var i = 0; i < results.length; i++) {
                                if (results[i].rating >= minRating) {
                                    filteredResults.push(results[i]);
                                }
                            }

                            for (var i = 0; i < filteredResults.length; i++) {
                                getPlaceDetails(filteredResults[i].place_id);
                            }

                            if (filteredResults.length > 0) {
                                map.setCenter(location);
                                map.setZoom(13);
                            }
                        } else {
                            alert("No restaurants found for this location.");
                        }
                    });
                } else {
                    alert("Geocode was not successful for the following reason: " + status);
                }
            });
        }

        function getPlaceDetails(placeId) {
            var request = {
                placeId: placeId,
                fields: ['name', 'formatted_address', 'international_phone_number', 'website', 'rating', 'opening_hours', 'price_level', 'reviews', 'geometry']
            };

            service.getDetails(request, function(place, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    createMarker(place);
                }
            });
        }

        function createMarker(place) {
            var marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location
            });

            markers.push(marker);

            google.maps.event.addListener(marker, 'click', function() {
                var openNow;
                if (place.opening_hours && place.opening_hours.isOpen) {
                    openNow = place.opening_hours.isOpen() ? 'Yes' : 'No';
                } else {
                    openNow = 'N/A';
                }
                var website;
                if (place.website) {
                    website = '<a href="' + place.website + '" target="_blank">' + place.website + '</a>';
                } else {
                    website = 'N/A';
                }
                var phone = place.international_phone_number || 'N/A';

                infowindow.setContent(
                    '<div>' +
                    '<strong>' + place.name + '</strong><br>' +
                    '<p><strong>Address:</strong> ' + place.formatted_address + '</p>' +
                    '<p><strong>Phone:</strong> ' + phone + '</p>' +
                    '<p><strong>Website:</strong> ' + website + '</p>' +
                    '<p><strong>Rating:</strong> ' + (place.rating || 'N/A') + ' (Based on Google Reviews)</p>' +
                    '<p><strong>Open Now:</strong> ' + openNow + '</p>' +
                    '<p><strong>Price Level:</strong> ' + (place.price_level || 'N/A') + '</p>' +
                    '<p><strong>Reviews:</strong></p>' +
                    '<div id="restaurant-reviews">' +
                    getReviewsHTML(place.reviews) +
                    '</div>' +
                    '</div>'
                );
                infowindow.open(map, marker);
            });
        }

        function getReviewsHTML(reviews) {
            var reviewsHTML = '';
            if (reviews && reviews.length > 0) {
                for (var i = 0; i < reviews.length; i++) {
                    reviewsHTML += '<div>' +
                        '<strong>' + reviews[i].author_name + '</strong>: ' + reviews[i].text + ' <br>' +
                        '<em>Rating: ' + reviews[i].rating + '</em>' +
                        '</div>';
                }
            } else {
                reviewsHTML = 'No reviews available.';
            }
            return reviewsHTML;
        }

        function clearMarkers() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }

        window.onload = initMap;
    </script>
{% endblock %}